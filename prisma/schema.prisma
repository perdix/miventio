// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organisation users that manage the organisation
model User {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  email      String @unique
  password  String?
  organisations Role[]
}

// Depending on the role, the users have different rights/roles
model Role {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role String
  userId String
  user User @relation(fields: [userId], references: [id])
  organisationId String
  organisation Organisation @relation(fields: [organisationId], references: [id])
  @@id([userId, organisationId])
}

// Central entity of the platform. An organisation might have contacts and events
model Organisation {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name       String @unique
  description String?
  color String?
  events Event[]
  users Role[]
  contacts Contact[]
  memberships Membership[]
}

// Contacts/members of the organisation
model Contact {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  oegbId String?
  efpId String?
  zaekId String?
  firstName String
  lastName  String
  gender String?
  prefix  String?
  postfix String?
  email      String
  password  String?
  phone      String?
  address   String?
  postcode  String?
  city      String?
  country   String?
  website String?
  company String?
  notes   String?
  newsletterConfirmation Boolean @default(false)
  status String?
  gdprConfirmation Boolean @default(false)
  organisationId String
  organisation Organisation @relation(fields: [organisationId], references: [id])
  visitors Visitor[]
  membershipFees MembershipFee[]
  membershipId String?
  membership Membership? @relation(fields: [membershipId], references: [id])
  @@unique([firstName, lastName, email])
}

model Membership{
  id  String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name String
  description String?
  price Float @default(0)
  color String @default("#FFFFFF")
  membershipFees MembershipFee[]
  contacts Contact[]
  organisationId String
  organisation Organisation @relation(fields: [organisationId], references: [id])
}

// A membership must be paid every year
model MembershipFee {
  id  String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  year String?
  membershipId String
  membership Membership @relation(fields: [membershipId], references: [id])
  price Float @default(0)
  prescribedAt DateTime?
  paidAt DateTime?
  contactId String
  contact Contact @relation(fields: [contactId], references: [id])
}

model Event {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name       String
  shortName String?
  description String?
  start DateTime?
  end DateTime?
  location String?
  city String?
  address String?
  postcode String?
  website String?
  bookingStart DateTime?
  bookingEnd DateTime?
  activities Activity[]
  bookings Booking[]
  eventTickets EventTicket[]
  visitors Visitor[]
  participationCategories ParticipationCategory[]
  organisationId String
  organisation Organisation @relation(fields: [organisationId], references: [id])
}

// To book an event you need a ticket
model EventTicket {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name  String
  price Float? @default(0)
  availableFrom DateTime?
  availableTo DateTime?
  dayTicketDate DateTime?
  eventId String
  event Event @relation(fields: [eventId], references: [id])
  visitors Visitor[]
  participationCategoryId String?
  participationCategory ParticipationCategory? @relation(fields: [participationCategoryId], references: [id])
}

// Each event can have several activities/subevents
model Activity {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name       String
  description String?
  date DateTime
  start DateTime?
  end DateTime?
  limit Int?
  location String?
  room String?
  speaker String?
  abstract String?
  sponsor String?
  eventId String
  event Event @relation(fields: [eventId], references: [id])
  credits Float?
  logo String?
  type String? // Can be choosen freely. E.g. workshop, lecture, party, ...
  activityTickets ActivityTicket[]
  visitors Visitor[]
}

model ActivityTicket {
  id  String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name String?
  activityId String
  activity Activity @relation(fields: [activityId], references: [id])
  visitors Visitor[]
  price Float @default(0)
  participationCategoryId String?
  participationCategory ParticipationCategory? @relation(fields: [participationCategoryId], references: [id])
}

// A booking is a complete order to access an event with one or several visitors
model Booking {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  firstName String
  lastName String
  email String
  address String
  postcode String
  city String
  phone String?
  status String @default("CREATED")
  price Float
  eventId String
  event Event @relation(fields: [eventId], references: [id])
  visitors Visitor[]
}

// The booking can contain one or more visitors. A visitor can exist without a booking as well.
model Visitor {
  id  String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status String?
  price Float
  eventTicketPrice Float
  eventId String
  event Event @relation(fields: [eventId], references: [id])
  eventTicketId String?
  eventTicket EventTicket? @relation(fields: [eventTicketId], references: [id])
  activitiesTicketsPrices Json // A list of all ticket prices of the selected activity tickets
  activities Activity[]
  activitiesTickets ActivityTicket[]
  bookingId String
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  firstName String
  lastName  String
  email String
  contactId String?
  contact Contact? @relation(fields: [contactId], references: [id])
  category String?
  participationCategoryId String?
  participationCategory ParticipationCategory? @relation(fields: [participationCategoryId], references: [id])
}


model ParticipationCategory {
  id  String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name String
  visitors Visitor[]
  activityTickets ActivityTicket[]
  eventTickets EventTicket[]
  eventId String
  event Event @relation(fields: [eventId], references: [id])
}
